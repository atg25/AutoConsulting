<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <title>Admin Deploy Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #fafafa;
        --surface: #ffffff;
        --text: #1a1a1a;
        --muted: #4b5563;
        --line: #e5e7eb;
        --link: #1d4ed8;
        --error: #b91c1c;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        background: var(--bg);
        color: var(--text);
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Helvetica,
          Arial,
          sans-serif;
      }

      .shell {
        width: min(880px, 100% - 2rem);
        margin: 2rem auto;
        display: grid;
        gap: 1rem;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 0.5rem;
        padding: 1rem;
      }

      h1,
      h2 {
        margin: 0;
        font-family: Georgia, "Times New Roman", Times, serif;
        font-style: italic;
        font-weight: 600;
      }

      h1 {
        font-size: clamp(1.5rem, 4vw, 2.1rem);
        line-height: 1.2;
      }

      h2 {
        font-size: 1.2rem;
        line-height: 1.3;
      }

      p {
        margin: 0.5rem 0 0;
        color: var(--muted);
        line-height: 1.6;
      }

      form {
        display: grid;
        gap: 0.75rem;
      }

      label {
        font-size: 0.92rem;
        color: var(--text);
        font-weight: 500;
      }

      input,
      textarea {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 0.45rem;
        padding: 0.65rem 0.75rem;
        font: inherit;
        color: var(--text);
        background: #fff;
      }

      textarea {
        min-height: 8rem;
        resize: vertical;
      }

      .row {
        display: grid;
        gap: 0.75rem;
      }

      @media (min-width: 720px) {
        .row.cols-2 {
          grid-template-columns: 1fr 1fr;
        }
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex-wrap: wrap;
      }

      button {
        border: 1px solid var(--text);
        background: var(--text);
        color: #fff;
        border-radius: 0.45rem;
        padding: 0.62rem 0.95rem;
        font: inherit;
        font-weight: 600;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        font-size: 0.92rem;
        color: var(--muted);
      }

      .status.error {
        color: var(--error);
      }

      .status.success {
        color: #166534;
      }

      .note {
        font-size: 0.88rem;
        color: var(--muted);
      }

      a {
        color: var(--link);
        text-underline-offset: 2px;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="panel">
        <h1>Admin Deploy Console</h1>
        <p>
          GitHub-native content deployment. This page triggers
          <code>workflow_dispatch</code> for the update workflow.
        </p>
      </section>

      <section class="panel">
        <h2>Trigger Update</h2>
        <form id="dispatchForm" autocomplete="off">
          <div class="row cols-2">
            <div>
              <label for="repoOwner">Owner</label>
              <input id="repoOwner" value="atg25" readonly />
            </div>
            <div>
              <label for="repoName">Repository</label>
              <input id="repoName" value="ai-consulting-portfolio" readonly />
            </div>
          </div>

          <div>
            <label for="workflowRef">Workflow Ref</label>
            <input id="workflowRef" value="main" readonly />
          </div>

          <div>
            <label for="patInput">Fine-grained PAT (session only)</label>
            <input
              id="patInput"
              type="password"
              placeholder="GitHub token"
              required
            />
            <p class="note">
              Stored in <code>sessionStorage</code> only for this tab session.
            </p>
          </div>

          <div>
            <label for="promptInput">Instruction Prompt</label>
            <textarea
              id="promptInput"
              placeholder="Example: Update work philosophy to emphasize measurable operational clarity while preserving efficiency, transparency, and automation."
              required
            ></textarea>
          </div>

          <div class="actions">
            <button id="dispatchBtn" type="submit">Deploy</button>
            <span id="statusText" class="status">Idle</span>
          </div>
        </form>

        <p id="runLinkWrap" class="note hidden">
          Latest run:
          <a id="runLink" href="#" target="_blank" rel="noreferrer"
            >Open Actions run</a
          >
        </p>
      </section>
    </main>

    <script>
      (function () {
        const OWNER = "atg25";
        const REPO = "ai-consulting-portfolio";
        const WORKFLOW_FILE = "update-site.yml";
        const STORAGE_KEY = "admin_pat_session";

        const form = document.getElementById("dispatchForm");
        const patInput = document.getElementById("patInput");
        const promptInput = document.getElementById("promptInput");
        const dispatchBtn = document.getElementById("dispatchBtn");
        const statusText = document.getElementById("statusText");
        const runLinkWrap = document.getElementById("runLinkWrap");
        const runLink = document.getElementById("runLink");

        const storedPat = sessionStorage.getItem(STORAGE_KEY);
        if (storedPat) {
          patInput.value = storedPat;
        }

        function setStatus(message, tone) {
          statusText.textContent = message;
          statusText.classList.remove("error", "success");
          if (tone) {
            statusText.classList.add(tone);
          }
        }

        function mapDispatchError(status, rawMessage) {
          const msg = String(rawMessage || "").toLowerCase();

          if (status === 401 || status === 403) {
            return "GitHub authorization failed. Check PAT permissions.";
          }
          if (status === 409 || msg.includes("conflict")) {
            return "GitHub branch conflict detected. Retry the deployment.";
          }
          if (status === 404) {
            return "Workflow not found. Verify update-site.yml exists on main.";
          }
          if (status === 422) {
            return "Invalid workflow dispatch payload. Check prompt and workflow inputs.";
          }
          return rawMessage || `GitHub API error (${status}).`;
        }

        async function fetchLatestRun(token) {
          const url = `https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?event=workflow_dispatch&per_page=1`;
          const response = await fetch(url, {
            headers: {
              Accept: "application/vnd.github+json",
              Authorization: `Bearer ${token}`,
              "X-GitHub-Api-Version": "2022-11-28",
            },
          });

          if (!response.ok) {
            return null;
          }

          const payload = await response.json();
          return payload?.workflow_runs?.[0] || null;
        }

        form.addEventListener("submit", async (event) => {
          event.preventDefault();

          const token = patInput.value.trim();
          const prompt = promptInput.value.trim();

          if (!token || !prompt) {
            setStatus("PAT and prompt are required.", "error");
            return;
          }

          sessionStorage.setItem(STORAGE_KEY, token);
          dispatchBtn.disabled = true;
          runLinkWrap.classList.add("hidden");
          setStatus("Dispatching workflow...", null);

          try {
            const response = await fetch(
              `https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches`,
              {
                method: "POST",
                headers: {
                  Accept: "application/vnd.github+json",
                  Authorization: `Bearer ${token}`,
                  "X-GitHub-Api-Version": "2022-11-28",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  ref: "main",
                  inputs: { prompt },
                }),
              },
            );

            if (!response.ok) {
              let message = "";
              try {
                const err = await response.json();
                message = err?.message || "";
              } catch {}
              throw new Error(mapDispatchError(response.status, message));
            }

            setStatus("Workflow dispatched successfully.", "success");

            await new Promise((resolve) => setTimeout(resolve, 2500));
            const run = await fetchLatestRun(token);
            if (run?.html_url) {
              runLink.href = run.html_url;
              runLinkWrap.classList.remove("hidden");
            }
          } catch (error) {
            setStatus(error.message || "Dispatch failed.", "error");
          } finally {
            dispatchBtn.disabled = false;
          }
        });
      })();
    </script>
  </body>
</html>
